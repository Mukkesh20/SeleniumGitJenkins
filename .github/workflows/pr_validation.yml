name: PR Approval Validation

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

# Required for PR comments
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check framework changes
        id: check-files
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          # Define framework paths (adjust to your structure)
          FRAMEWORK_PATTERNS="^src/framework/|^src/core/|/base/"
          
          if echo "$CHANGED_FILES" | grep -E "$FRAMEWORK_PATTERNS"; then
            echo "framework_changed=true" >> $GITHUB_OUTPUT
            echo "Framework files changed"
          else
            echo "framework_changed=false" >> $GITHUB_OUTPUT
            echo "No framework files changed"
          fi
      
      - name: Validate approvals
        uses: actions/github-script@v7
        with:
          script: |
            const frameworkChanged = '${{ steps.check-files.outputs.framework_changed }}' === 'true';
            const qtfCoreTeam = ['user1', 'user2', 'user3']; // Replace with actual usernames
            
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const approvals = reviews.filter(r => r.state === 'APPROVED');
            const qtfCoreApprovals = approvals.filter(r => 
              qtfCoreTeam.includes(r.user.login)
            );
            
            if (frameworkChanged) {
              if (approvals.length < 2) {
                core.setFailed('Framework changes require 2 approvals');
              }
              if (qtfCoreApprovals.length < 1) {
                core.setFailed('Framework changes require at least 1 approval from QTF core team');
              }
            } else {
              if (approvals.length < 1) {
                core.setFailed('All changes require at least 1 approval');
              }
            }
