name: Auto-Merge PR

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            
            if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            } else if (context.payload.review) {
              prNumber = context.payload.review.pull_request.number;
            } else if (context.payload.check_suite) {
              const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.payload.check_suite.head_sha
              });
              if (prs.length > 0) {
                prNumber = prs[0].number;
              }
            }
            
            if (!prNumber) {
              console.log('No PR found, skipping');
              return;
            }
            
            core.setOutput('number', prNumber);
            console.log(`Found PR #${prNumber}`);
      
      - name: Check and auto-merge
        if: steps.pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.number }}');
            
            console.log('='.repeat(60));
            console.log(`Auto-Merge Check for PR #${prNumber}`);
            console.log('='.repeat(60));
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Skip if draft or not open
            if (pr.draft) {
              console.log('‚ùå PR is draft, skipping auto-merge');
              return;
            }
            
            if (pr.state !== 'open') {
              console.log('‚ùå PR is not open, skipping auto-merge');
              return;
            }
            
            const labels = pr.labels.map(l => l.name);
            console.log(`Labels: ${labels.join(', ') || 'none'}`);
            
            const isFramework = labels.includes('framework');
            const isTest = labels.some(l => l === 'tests' || l === 'test' || l.includes('test'));
            
            console.log(`Framework: ${isFramework}, Test: ${isTest}`);
            
            // Only auto-merge test and framework changes
            if (!isFramework && !isTest) {
              console.log('‚è≠Ô∏è  Not a test/framework change, skipping auto-merge');
              return;
            }
            
            // Check if validation check passed
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const validationCheck = checkRuns.check_runs.find(c => c.name === 'validate-approvals');
            
            if (!validationCheck) {
              console.log('‚è≥ validate-approvals check not found yet');
              return;
            }
            
            console.log(`validate-approvals status: ${validationCheck.status}`);
            console.log(`validate-approvals conclusion: ${validationCheck.conclusion}`);
            
            if (validationCheck.status !== 'completed') {
              console.log('‚è≥ validate-approvals still running');
              return;
            }
            
            if (validationCheck.conclusion !== 'success') {
              console.log('‚ùå validate-approvals did not pass, cannot auto-merge');
              return;
            }
            
            // Check other required checks
            const failedChecks = checkRuns.check_runs.filter(c => 
              c.status === 'completed' && 
              c.conclusion !== 'success' && 
              c.conclusion !== 'neutral' &&
              c.conclusion !== 'skipped'
            );
            
            if (failedChecks.length > 0) {
              console.log('‚ùå Some checks failed:');
              failedChecks.forEach(c => console.log(`  - ${c.name}: ${c.conclusion}`));
              return;
            }
            
            const incompleteChecks = checkRuns.check_runs.filter(c => 
              c.status !== 'completed' &&
              c.name !== 'auto-merge' // Ignore this workflow
            );
            
            if (incompleteChecks.length > 0) {
              console.log('‚è≥ Some checks still running:');
              incompleteChecks.forEach(c => console.log(`  - ${c.name}`));
              return;
            }
            
            console.log('‚úÖ All checks passed, attempting auto-merge');
            
            try {
              // Try GraphQL auto-merge first
              await github.graphql(`
                mutation($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: SQUASH
                  }) {
                    pullRequest {
                      autoMergeRequest {
                        enabledAt
                      }
                    }
                  }
                }
              `, {
                pullRequestId: pr.node_id
              });
              
              console.log('‚úÖ Auto-merge enabled via GraphQL');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'ü§ñ **Auto-merge enabled**\n\nAll approval requirements met. PR will merge automatically.'
              });
              
            } catch (graphqlError) {
              console.log('GraphQL auto-merge not available, trying direct merge');
              console.log(`Error: ${graphqlError.message}`);
              
              // Fallback: Direct merge
              try {
                const mergeResult = await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'squash',
                  commit_title: pr.title,
                  commit_message: `Auto-merged by GitHub Actions\n\nAll approval requirements were met.`
                });
                
                console.log('‚úÖ PR merged successfully via REST API');
                console.log(`Merge SHA: ${mergeResult.data.sha}`);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: 'üéâ **PR auto-merged successfully!**\n\nAll approval requirements were met and checks passed.'
                });
                
              } catch (mergeError) {
                console.error('‚ùå Failed to merge PR');
                console.error(`Error: ${mergeError.message}`);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `‚ö†Ô∏è **Auto-merge failed**\n\nAll requirements were met but merge failed: ${mergeError.message}\n\nPlease merge manually.`
                });
              }
            }
