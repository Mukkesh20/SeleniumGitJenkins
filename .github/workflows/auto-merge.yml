name: PR Change Detector

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect change types
        id: changes
        run: |
          # Get list of changed files in the PR
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Initialize flags
          FRAMEWORK_CHANGES="false"
          TEST_CHANGES="false"
          CONFIG_CHANGES="false"
          
          # Check each file against patterns
          while IFS= read -r file; do
            # Skip empty lines
            [[ -z "$file" ]] && continue
            
            echo "Checking: $file"
            
            # Framework changes: /utils, /dal, /core, /lib, /common directories
            if [[ "$file" =~ ^(utils|dal|core|lib|common)/ ]] || \
               [[ "$file" =~ /(utils|dal|core|lib|common)/ ]]; then
              FRAMEWORK_CHANGES="true"
              echo "  ‚Üí Framework change detected"
            fi
            
            # Test case changes: /module2 directory
            if [[ "$file" =~ ^module2/ ]] || [[ "$file" =~ /module2/ ]]; then
              TEST_CHANGES="true"
              echo "  ‚Üí Test change detected"
            fi
            
            # Config changes: *.conf, *.config, *.properties, *.yml, *.yaml in config dirs
            if [[ "$file" =~ \.(conf|config|properties|yml|yaml)$ ]] || \
               [[ "$file" =~ ^config/ ]] || \
               [[ "$file" =~ /config/ ]]; then
              CONFIG_CHANGES="true"
              echo "  ‚Üí Config change detected"
            fi
          done <<< "$CHANGED_FILES"
          
          # Set outputs
          echo "framework=$FRAMEWORK_CHANGES" >> $GITHUB_OUTPUT
          echo "tests=$TEST_CHANGES" >> $GITHUB_OUTPUT
          echo "config=$CONFIG_CHANGES" >> $GITHUB_OUTPUT
          
          # Summary
          echo ""
          echo "=== Change Summary ==="
          echo "Framework changes: $FRAMEWORK_CHANGES"
          echo "Test changes: $TEST_CHANGES"
          echo "Config changes: $CONFIG_CHANGES"

      - name: Add labels based on changes
        uses: actions/github-script@v7
        with:
          script: |
            const framework = '${{ steps.changes.outputs.framework }}' === 'true';
            const tests = '${{ steps.changes.outputs.tests }}' === 'true';
            const config = '${{ steps.changes.outputs.config }}' === 'true';
            
            console.log('='.repeat(60));
            console.log('Label Assignment');
            console.log('='.repeat(60));
            console.log(`Framework: ${framework}`);
            console.log(`Tests: ${tests}`);
            console.log(`Config: ${config}`);
            console.log(`PR Number: ${context.payload.pull_request.number}`);
            
            const labelsToAdd = [];
            const labelsToRemove = [];
            
            // Use simple label names
            const allPossibleLabels = ['framework', 'tests', 'config'];
            
            // Determine which labels to add
            if (framework) labelsToAdd.push('framework');
            if (tests) labelsToAdd.push('tests');
            if (config) labelsToAdd.push('config');
            
            // Labels to remove are those not being added
            for (const label of allPossibleLabels) {
              if (!labelsToAdd.includes(label)) {
                labelsToRemove.push(label);
              }
            }
            
            console.log(`Labels to add: ${labelsToAdd.join(', ') || 'none'}`);
            console.log(`Labels to remove: ${labelsToRemove.join(', ') || 'none'}`);
            
            // Get current labels on the PR
            try {
              const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number
              });
              const currentLabelNames = currentLabels.map(l => l.name);
              
              console.log(`Current labels: ${currentLabelNames.join(', ') || 'none'}`);
              
              // Add new labels
              const labelsToActuallyAdd = labelsToAdd.filter(l => !currentLabelNames.includes(l));
              if (labelsToActuallyAdd.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  labels: labelsToActuallyAdd
                });
                console.log(`‚úÖ Added labels: ${labelsToActuallyAdd.join(', ')}`);
              } else {
                console.log('‚ÑπÔ∏è  All required labels already present');
              }
              
              // Remove labels that no longer apply
              for (const label of labelsToRemove) {
                if (currentLabelNames.includes(label)) {
                  try {
                    await github.rest.issues.removeLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: context.payload.pull_request.number,
                      name: label
                    });
                    console.log(`‚úÖ Removed label: ${label}`);
                  } catch (e) {
                    console.log(`‚ö†Ô∏è  Could not remove label ${label}: ${e.message}`);
                  }
                }
              }
              
              console.log('='.repeat(60));
              console.log('Label assignment complete');
              console.log('='.repeat(60));
              
            } catch (error) {
              console.error('‚ùå Error managing labels:', error);
              core.setFailed(`Failed to manage labels: ${error.message}`);
            }

      - name: Post change summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const framework = '${{ steps.changes.outputs.framework }}' === 'true';
            const tests = '${{ steps.changes.outputs.tests }}' === 'true';
            const config = '${{ steps.changes.outputs.config }}' === 'true';
            
            let body = '## üìã PR Change Detection Summary\n\n';
            body += '| Category | Detected | Review Focus |\n';
            body += '|----------|----------|-------------|\n';
            body += `| üîß Framework (\`/utils\`, \`/dal\`, \`/core\`, \`/lib\`, \`/common\`) | ${framework ? '‚úÖ Yes' : '‚ùå No'} | ${framework ? '**High** - Core framework impact' : 'N/A'} |\n`;
            body += `| üß™ Test Cases (\`/module2\`) | ${tests ? '‚úÖ Yes' : '‚ùå No'} | ${tests ? 'Standard - Test coverage' : 'N/A'} |\n`;
            body += `| ‚öôÔ∏è Config Files | ${config ? '‚úÖ Yes' : '‚ùå No'} | ${config ? '**Medium** - Environment impact' : 'N/A'} |\n`;
            
            // Add approval requirements info
            body += '\n### üìù Approval Requirements\n';
            if (framework) {
              body += '- **Framework changes** detected: Requires **2 approvals** (at least 1 from QTF core team)\n';
              body += '- Auto-merge will be enabled once requirements are met\n';
            } else if (tests) {
              body += '- **Test-only changes** detected: Requires **2 approvals** (any reviewers)\n';
              body += '- Auto-merge will be enabled once requirements are met\n';
            } else {
              body += '- **Standard changes**: Requires **1 approval** (any reviewer)\n';
            }
            
            // Add review guidance
            if (framework) {
              body += '\n### ‚ö†Ô∏è Framework Changes Detected\n';
              body += 'This PR modifies core framework components. Please ensure:\n';
              body += '- ‚úì Backward compatibility is maintained\n';
              body += '- ‚úì Existing tests pass\n';
              body += '- ‚úì Documentation is updated if APIs changed\n';
              
              if (!tests) {
                body += '\n### üìù Note: No test changes detected\n';
                body += 'Consider adding tests for the framework changes.\n';
              }
            }
            
            try {
              // Find and update existing comment or create new one
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number
              });
              
              const botComment = comments.find(c => 
                c.user.type === 'Bot' && 
                c.body.includes('PR Change Detection Summary')
              );
              
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
                console.log('‚úÖ Updated existing comment');
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: body
                });
                console.log('‚úÖ Created new comment');
              }
            } catch (error) {
              console.error('‚ùå Error posting comment:', error);
            }
