name: PR Approval Check

on:
  pull_request_review:
    types: [submitted, dismissed]
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write  # Changed from 'read' to 'write'
  issues: write         # Added

jobs:
  validate-approvals:
    name: validate-approvals
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Handle both pull_request and pull_request_review events
              let pr;
              if (context.payload.pull_request) {
                pr = context.payload.pull_request;
              } else if (context.payload.review) {
                // For pull_request_review events
                const { data: prData } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.payload.review.pull_request.number
                });
                pr = prData;
              } else {
                console.log('No PR found in context');
                core.setOutput('number', '');
                core.setOutput('labels', '');
                return;
              }
              
              const labels = pr.labels.map(l => l.name);
              
              core.setOutput('number', pr.number);
              core.setOutput('labels', labels.join(','));
              
              console.log(`PR #${pr.number}`);
              console.log(`Labels: ${labels.join(', ') || 'none'}`);
            } catch (error) {
              console.error('Error getting PR info:', error);
              core.setFailed(`Failed to get PR info: ${error.message}`);
            }
      
      - name: Validate approval requirements
        if: steps.pr-info.outputs.number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.pr-info.outputs.number }}');
            const labels = '${{ steps.pr-info.outputs.labels }}'.split(',').filter(Boolean);
            
            // QTF Core Team - REPLACE WITH ACTUAL GITHUB USERNAMES
            const QTF_CORE_TEAM = [
              'username1',
              'username2', 
              'username3'
            ];
            
            console.log('='.repeat(60));
            console.log(`PR #${prNumber} - Approval Validation`);
            console.log(`Event: ${context.eventName}`);
            console.log('='.repeat(60));
            
            // Check for framework or tests labels
            const isFramework = labels.includes('framework');
            const isTest = labels.includes('tests');
            
            console.log(`\nChange Type:`);
            console.log(`  Framework: ${isFramework}`);
            console.log(`  Test: ${isTest}`);
            console.log(`  Labels: ${labels.join(', ') || 'none'}`);
            
            // If no relevant label, pass the check
            if (!isFramework && !isTest) {
              console.log(`\nâœ… No framework/test label - standard review process applies`);
              return;
            }
            
            try {
              // Get all reviews
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              // Get latest review state per reviewer
              const latestReviews = {};
              for (const review of reviews) {
                const user = review.user.login;
                if (!latestReviews[user] || 
                    new Date(review.submitted_at) > new Date(latestReviews[user].submitted_at)) {
                  latestReviews[user] = review;
                }
              }
              
              // Count approvals
              const allApprovals = Object.values(latestReviews).filter(r => r.state === 'APPROVED');
              const approvedBy = allApprovals.map(r => r.user.login);
              const totalApprovals = allApprovals.length;
              const coreApprovals = allApprovals.filter(r => QTF_CORE_TEAM.includes(r.user.login));
              const coreApprovedBy = coreApprovals.map(r => r.user.login);
              
              console.log(`\nCurrent Approvals:`);
              console.log(`  Total: ${totalApprovals}`);
              console.log(`  Approved by: ${approvedBy.join(', ') || 'none'}`);
              console.log(`  Core team approvals: ${coreApprovals.length}`);
              if (coreApprovals.length > 0) {
                console.log(`  Core team approved by: ${coreApprovedBy.join(', ')}`);
              }
              
              // Apply approval rules
              let passed = false;
              let message = '';
              
              if (isTest) {
                // TEST CHANGES: Require 2 approvals
                console.log(`\nRule: Test changes require 2 approvals`);
                
                if (totalApprovals >= 2) {
                  passed = true;
                  message = `âœ… **Test change approved**\n\n${totalApprovals} approvals received. Requirements met.`;
                } else {
                  passed = false;
                  message = `âŒ **Test change requires 2 approvals**\n\nCurrent: ${totalApprovals}\nNeeded: ${2 - totalApprovals} more`;
                }
                
              } else if (isFramework) {
                // FRAMEWORK CHANGES: Require 2 approvals with 1 from core
                console.log(`\nRule: Framework changes require 2 approvals (1 from core)`);
                console.log(`Core team: ${QTF_CORE_TEAM.join(', ')}`);
                
                if (totalApprovals >= 2 && coreApprovals.length >= 1) {
                  passed = true;
                  message = `âœ… **Framework change approved**\n\n${totalApprovals} approvals (${coreApprovals.length} from core). Requirements met.`;
                } else if (totalApprovals < 2) {
                  passed = false;
                  message = `âŒ **Framework change requires 2 approvals**\n\nCurrent: ${totalApprovals}\nNeeded: ${2 - totalApprovals} more ${coreApprovals.length === 0 ? '(at least 1 from core)' : ''}`;
                } else if (coreApprovals.length < 1) {
                  passed = false;
                  message = `âŒ **Framework change requires core team approval**\n\n` +
                           `Approvers: ${approvedBy.join(', ')}\n` +
                           `Core team: ${QTF_CORE_TEAM.join(', ')}\n\n` +
                           `Need 1 approval from core team.`;
                }
              }
              
              console.log(`\n${'='.repeat(60)}`);
              console.log(message.replace(/\n/g, ' - '));
              console.log('='.repeat(60));
              
              // Post comment only on review events
              if (context.eventName === 'pull_request_review') {
                try {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    body: `ðŸ¤– **Approval Validation**\n\n${message}`
                  });
                } catch (commentError) {
                  console.log(`Could not post comment: ${commentError.message}`);
                }
              }
              
              // Fail if requirements not met
              if (!passed) {
                core.setFailed(message.replace(/\*\*/g, '').replace(/\n/g, ' '));
              } else {
                console.log('âœ… All requirements met!');
              }
              
            } catch (error) {
              console.error('Error validating approvals:', error);
              core.setFailed(`Failed to validate approvals: ${error.message}`);
            }
