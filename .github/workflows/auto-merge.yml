name: PR Approval Check

on:
  pull_request_review:
    types: [submitted, dismissed]
  pull_request:
    types: [labeled, unlabeled]  # Only label events, NOT opened/synchronize

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-approvals:
    name: validate-approvals
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR number
        id: pr-number
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            
            if (context.eventName === 'workflow_run') {
              // Get PR from the workflow_run event
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
              });
              
              if (prs.length === 0) {
                console.log('No open PR found for this branch');
                return;
              }
              
              prNumber = prs[0].number;
            } else if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            }
            
            if (!prNumber) {
              console.log('Could not determine PR number');
              return;
            }
            
            core.setOutput('number', prNumber);
            console.log(`PR #${prNumber}`);
      
      - name: Validate approvals
        if: steps.pr-number.outputs.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr-number.outputs.number }}');
            
            // Add small delay if triggered by workflow_run
            if (context.eventName === 'workflow_run') {
              console.log('Waiting for labels to be committed...');
              await new Promise(resolve => setTimeout(resolve, 3000));
            }
            
            // Fetch fresh PR data
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const labels = pr.labels.map(l => l.name);
            
            console.log('='.repeat(60));
            console.log(`PR #${prNumber} - Approval Validation`);
            console.log(`Triggered by: ${context.eventName}`);
            console.log('='.repeat(60));
            console.log(`Labels: ${labels.join(', ') || 'none'}`);
            
            const QTF_CORE_TEAM = ['username1', 'username2', 'username3']; // REPLACE WITH ACTUAL USERNAMES
            
            const isFramework = labels.includes('framework');
            const isTest = labels.some(l => l === 'tests' || l === 'test' || l.includes('test'));
            
            console.log(`Framework: ${isFramework}, Test: ${isTest}`);
            
            if (!isFramework && !isTest) {
              console.log('✅ No special requirements');
              return;
            }
            
            // Get reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const latestReviews = {};
            reviews.forEach(review => {
              const user = review.user.login;
              if (!latestReviews[user] || new Date(review.submitted_at) > new Date(latestReviews[user].submitted_at)) {
                latestReviews[user] = review;
              }
            });
            
            const approvals = Object.values(latestReviews).filter(r => r.state === 'APPROVED');
            const approvedBy = approvals.map(r => r.user.login);
            const totalApprovals = approvals.length;
            const coreApprovals = approvals.filter(r => QTF_CORE_TEAM.includes(r.user.login)).length;
            
            console.log(`Approvals: ${totalApprovals} (${coreApprovals} from core)`);
            console.log(`Approved by: ${approvedBy.join(', ') || 'none'}`);
            
            let passed = false;
            let message = '';
            
            if (isTest) {
              // TEST CHANGES: MUST HAVE 1 APPROVALS
              if (totalApprovals >= 1) {
                passed = true;
                message = `✅ Test change approved: ${totalApprovals} approvals (requirement: 1)`;
              } else {
                passed = false;
                message = `❌ Test change needs 1 approvals (current: ${totalApprovals}, need: ${1 - totalApprovals} more)`;
              }
            } else if (isFramework) {
              // FRAMEWORK CHANGES: MUST HAVE 2 APPROVALS WITH 1 FROM CORE
              if (totalApprovals >= 2 && coreApprovals >= 1) {
                passed = true;
                message = `✅ Framework change approved: ${totalApprovals} approvals (${coreApprovals} from core)`;
              } else if (totalApprovals < 2) {
                passed = false;
                message = `❌ Framework needs 2 approvals (current: ${totalApprovals}, need: ${2 - totalApprovals} more)`;
              } else {
                passed = false;
                message = `❌ Framework needs at least 1 core team approval (core team: ${QTF_CORE_TEAM.join(', ')})`;
              }
            }
            
            console.log(`\n${message}`);
            console.log(`Check will ${passed ? 'PASS ✅' : 'FAIL ❌'}`);
            
            // CRITICAL: Fail the check if requirements not met
            if (!passed) {
              core.setFailed(message);
            } else {
              console.log('✅ All requirements met - merge allowed');
            }
