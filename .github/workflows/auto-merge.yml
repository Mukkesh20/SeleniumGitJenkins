name: PR Approval Check

on:
  pull_request_review:
    types: [submitted, dismissed]
  pull_request:
    types: [labeled, unlabeled]
  workflow_run:
    workflows: ["PR Change Detector"]  # Must match label workflow name exactly
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-approvals:
    name: validate-approvals
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR number
        id: pr-number
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            
            if (context.eventName === 'workflow_run') {
              // Get PR from the workflow_run event
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
              });
              
              if (prs.length === 0) {
                console.log('No open PR found for this branch');
                return;
              }
              
              prNumber = prs[0].number;
            } else if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            }
            
            if (!prNumber) {
              console.log('Could not determine PR number');
              return;
            }
            
            core.setOutput('number', prNumber);
            console.log(`PR #${prNumber}`);
      
      - name: Validate approvals
        if: steps.pr-number.outputs.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr-number.outputs.number }}');
            
            // Add small delay if triggered by workflow_run
            if (context.eventName === 'workflow_run') {
              console.log('Waiting for labels to be committed...');
              await new Promise(resolve => setTimeout(resolve, 3000));
            }
            
            // Fetch fresh PR data
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const labels = pr.labels.map(l => l.name);
            
            console.log('='.repeat(60));
            console.log(`PR #${prNumber} - Approval Validation`);
            console.log(`Triggered by: ${context.eventName}`);
            console.log('='.repeat(60));
            console.log(`Labels: ${labels.join(', ') || 'none'}`);
            
            const QTF_CORE_TEAM = ['username1', 'username2', 'username3']; // REPLACE
            
            const isFramework = labels.includes('framework');
            const isTest = labels.includes('tests');
            
            console.log(`Framework: ${isFramework}, Test: ${isTest}`);
            
            if (!isFramework && !isTest) {
              console.log('✅ No special requirements');
              return;
            }
            
            // Get reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const latestReviews = {};
            reviews.forEach(review => {
              const user = review.user.login;
              if (!latestReviews[user] || new Date(review.submitted_at) > new Date(latestReviews[user].submitted_at)) {
                latestReviews[user] = review;
              }
            });
            
            const approvals = Object.values(latestReviews).filter(r => r.state === 'APPROVED');
            const totalApprovals = approvals.length;
            const coreApprovals = approvals.filter(r => QTF_CORE_TEAM.includes(r.user.login)).length;
            
            console.log(`Approvals: ${totalApprovals} (${coreApprovals} from core)`);
            
            let passed = false;
            let message = '';
            
            if (isTest) {
              passed = totalApprovals >= 2;
              message = passed 
                ? `✅ Test: ${totalApprovals} approvals` 
                : `❌ Test needs 2 approvals (have ${totalApprovals})`;
            } else if (isFramework) {
              passed = totalApprovals >= 2 && coreApprovals >= 1;
              message = passed
                ? `✅ Framework: ${totalApprovals} approvals (${coreApprovals} from core)`
                : totalApprovals < 2
                  ? `❌ Framework needs 2 approvals (have ${totalApprovals})`
                  : `❌ Framework needs core approval (team: ${QTF_CORE_TEAM.join(', ')})`;
            }
            
            console.log(message);
            
            if (!passed) {
              core.setFailed(message);
            }
