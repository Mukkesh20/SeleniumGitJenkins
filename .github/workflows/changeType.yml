name: PR Change Detector

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      framework: ${{ steps.changes.outputs.framework }}
      tests: ${{ steps.changes.outputs.tests }}
      config: ${{ steps.changes.outputs.config }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect change types
        id: changes
        run: |
          # Get list of changed files in the PR
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Initialize flags
          FRAMEWORK_CHANGES="false"
          TEST_CHANGES="false"
          CONFIG_CHANGES="false"
          
          # Check each file against patterns
          while IFS= read -r file; do
            # Skip empty lines
            [[ -z "$file" ]] && continue
            
            # Framework changes: /utils, /dal, /core, /lib, /common directories
            if [[ "$file" =~ ^(utils|dal|core|lib|common)/ ]] || \
               [[ "$file" =~ /(utils|dal|core|lib|common)/ ]]; then
              FRAMEWORK_CHANGES="true"
              echo "Framework change detected: $file"
            fi
            
            # Test case changes: /tests directory
            if [[ "$file" =~ ^module2/ ]] || [[ "$file" =~ /tests/ ]]; then
              TEST_CHANGES="true"
              echo "Test change detected: $file"
            fi
            
            # Config changes: *.conf, *.config, *.properties, *.yml, *.yaml in config dirs
            if [[ "$file" =~ \.conf$ ]] || \
               [[ "$file" =~ \.config$ ]] || \
               [[ "$file" =~ \.properties$ ]] || \
               [[ "$file" =~ ^config/ ]] || \
               [[ "$file" =~ /config/ ]]; then
              CONFIG_CHANGES="true"
              echo "Config change detected: $file"
            fi
          done <<< "$CHANGED_FILES"
          
          # Set outputs
          echo "framework=$FRAMEWORK_CHANGES" >> $GITHUB_OUTPUT
          echo "tests=$TEST_CHANGES" >> $GITHUB_OUTPUT
          echo "config=$CONFIG_CHANGES" >> $GITHUB_OUTPUT
          
          # Summary
          echo ""
          echo "=== Change Summary ==="
          echo "Framework changes: $FRAMEWORK_CHANGES"
          echo "Test changes: $TEST_CHANGES"
          echo "Config changes: $CONFIG_CHANGES"

      - name: Add labels based on changes
        uses: actions/github-script@v7
        with:
          script: |
            const framework = '${{ steps.changes.outputs.framework }}' === 'true';
            const tests = '${{ steps.changes.outputs.tests }}' === 'true';
            const config = '${{ steps.changes.outputs.config }}' === 'true';
            
            const labelsToAdd = [];
            const labelsToRemove = [];
            
            // Define label mappings
            const labelMap = {
              framework: 'type:framework',
              tests: 'type:tests',
              config: 'type:config'
            };
            
            // Determine which labels to add/remove
            if (framework) labelsToAdd.push(labelMap.framework);
            else labelsToRemove.push(labelMap.framework);
            
            if (tests) labelsToAdd.push(labelMap.tests);
            else labelsToRemove.push(labelMap.tests);
            
            if (config) labelsToAdd.push(labelMap.config);
            else labelsToRemove.push(labelMap.config);
            
            // Get current labels on the PR
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const currentLabelNames = currentLabels.map(l => l.name);
            
            // Add new labels
            const labelsToActuallyAdd = labelsToAdd.filter(l => !currentLabelNames.includes(l));
            if (labelsToActuallyAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labelsToActuallyAdd
              });
              console.log(`Added labels: ${labelsToActuallyAdd.join(', ')}`);
            }
            
            // Remove labels that no longer apply
            for (const label of labelsToRemove) {
              if (currentLabelNames.includes(label)) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: label
                  });
                  console.log(`Removed label: ${label}`);
                } catch (e) {
                  // Label might not exist, ignore
                }
              }
            }

      - name: Post change summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const framework = '${{ steps.changes.outputs.framework }}' === 'true';
            const tests = '${{ steps.changes.outputs.tests }}' === 'true';
            const config = '${{ steps.changes.outputs.config }}' === 'true';
            
            let body = '## ðŸ“‹ PR Change Detection Summary\n\n';
            body += '| Category | Detected | Review Focus |\n';
            body += '|----------|----------|-------------|\n';
            body += `| ðŸ”§ Framework (\`/utils\`, \`/dal\`, etc.) | ${framework ? 'âœ… Yes' : 'âŒ No'} | ${framework ? '**High** - Core framework impact' : 'N/A'} |\n`;
            body += `| ðŸ§ª Test Cases (\`/tests\`) | ${tests ? 'âœ… Yes' : 'âŒ No'} | ${tests ? 'Standard - Test coverage' : 'N/A'} |\n`;
            body += `| âš™ï¸ Config (\`*.conf\`) | ${config ? 'âœ… Yes' : 'âŒ No'} | ${config ? '**Medium** - Environment impact' : 'N/A'} |\n`;
            
            // Add review guidance based on detected changes
            if (framework) {
              body += '\n### âš ï¸ Framework Changes Detected\n';
              body += 'This PR modifies core framework components. Please ensure:\n';
              body += '- Backward compatibility is maintained\n';
              body += '- Existing tests pass\n';
              body += '- Documentation is updated if APIs changed\n';
            }
            
            if (framework && !tests) {
              body += '\n### ðŸ“ Note: No test changes detected for framework modifications\n';
              body += 'Consider adding tests for the framework changes.\n';
            }
            
            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('PR Change Detection Summary')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
