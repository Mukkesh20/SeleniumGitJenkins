name: Code Linting and Quality Checks

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

jobs:
  lint:
    name: Java Code Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 1.8
        uses: actions/setup-java@v4
        with:
          java-version: '8.0.442+6'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Compile project
        id: compile
        run: |
          echo "Starting compilation..."
          
          # Run Maven and capture both output and exit code
          set +e
          mvn clean compile -DskipTests 2>&1 | tee compile.log
          MAVEN_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          echo "Maven exit code: $MAVEN_EXIT_CODE"
          echo $MAVEN_EXIT_CODE > compile_exit_code.txt
          
          # Determine compilation status
          FAILED=false
          FAILURE_REASON=""
          
          # Check 1: Maven exit code
          if [ $MAVEN_EXIT_CODE -ne 0 ]; then
            FAILED=true
            FAILURE_REASON="Maven exited with code $MAVEN_EXIT_CODE"
          fi
          
          # Check 2: BUILD FAILURE in output
          if grep -q "BUILD FAILURE" compile.log; then
            FAILED=true
            FAILURE_REASON="BUILD FAILURE detected in output"
          fi
          
          # Check 3: Compilation errors (excluding benign messages)
          ERROR_COUNT=$(grep -c "\[ERROR\]" compile.log 2>/dev/null || echo "0")
          # Filter out non-critical errors
          REAL_ERRORS=$(grep "\[ERROR\]" compile.log 2>/dev/null | grep -v "Re-run Maven" | grep -v "For more information" | wc -l || echo "0")
          
          if [ "$REAL_ERRORS" -gt 0 ]; then
            FAILED=true
            FAILURE_REASON="Found $REAL_ERRORS compilation error(s)"
          fi
          
          # Check 4: Specific compilation failure indicators
          if grep -q "COMPILATION ERROR" compile.log; then
            FAILED=true
            FAILURE_REASON="COMPILATION ERROR detected"
          fi
          
          # Set outputs and exit appropriately
          if [ "$FAILED" = true ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "exit_code=1" >> $GITHUB_OUTPUT
            echo "reason=$FAILURE_REASON" >> $GITHUB_OUTPUT
            echo ""
            echo "=========================================="
            echo "‚ùå COMPILATION FAILED: $FAILURE_REASON"
            echo "=========================================="
            echo ""
            echo "Error details:"
            grep "\[ERROR\]" compile.log | grep -v "Re-run Maven" | grep -v "For more information" || true
            echo ""
            exit 1
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "exit_code=0" >> $GITHUB_OUTPUT
            echo ""
            echo "=========================================="
            echo "‚úÖ COMPILATION SUCCESSFUL"
            echo "=========================================="
          fi

      - name: Verify Compile Status
        if: always()
        run: |
          echo "Compile status: ${{ steps.compile.outputs.status }}"
          echo "Exit code: ${{ steps.compile.outputs.exit_code }}"
          echo "Reason: ${{ steps.compile.outputs.reason }}"
          
          if [ -f compile_exit_code.txt ]; then
            echo "Maven exit code from file: $(cat compile_exit_code.txt)"
          fi

      - name: Run Checkstyle (Report Only)
        if: steps.compile.outputs.status == 'success'
        run: mvn checkstyle:checkstyle || true
        continue-on-error: true

      - name: Run PMD (Report Only)
        if: steps.compile.outputs.status == 'success'
        run: mvn pmd:pmd || true
        continue-on-error: true

      - name: Run SpotBugs (Report Only)
        if: steps.compile.outputs.status == 'success'
        run: mvn spotbugs:spotbugs || true
        continue-on-error: true

      - name: Generate Quality Report Summary
        if: always()
        run: |
          echo "## üìä Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Compilation Status
          echo "### üî® Compilation" >> $GITHUB_STEP_SUMMARY
          COMPILE_STATUS="${{ steps.compile.outputs.status }}"
          
          if [ "$COMPILE_STATUS" = "success" ]; then
            echo "‚úÖ **Status:** SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** FAILED" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** ${{ steps.compile.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "compile.log" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>üìã Click to see compilation errors</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              
              # Extract error lines
              grep "\[ERROR\]" compile.log | grep -v "Re-run Maven" | grep -v "For more information" | head -20 >> $GITHUB_STEP_SUMMARY || echo "See compile.log artifact for full details"
              
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Only show linting results if compilation succeeded
          if [ "$COMPILE_STATUS" = "success" ]; then
            # Checkstyle Summary
            if [ -f "target/checkstyle-result.xml" ]; then
              CHECKSTYLE_ERRORS=$(grep -o 'severity="error"' target/checkstyle-result.xml | wc -l || echo "0")
              CHECKSTYLE_WARNINGS=$(grep -o 'severity="warning"' target/checkstyle-result.xml | wc -l || echo "0")
              CHECKSTYLE_INFO=$(grep -o 'severity="info"' target/checkstyle-result.xml | wc -l || echo "0")
              echo "### ‚úÖ Checkstyle Analysis" >> $GITHUB_STEP_SUMMARY
              echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Errors | $CHECKSTYLE_ERRORS |" >> $GITHUB_STEP_SUMMARY
              echo "| Warnings | $CHECKSTYLE_WARNINGS |" >> $GITHUB_STEP_SUMMARY
              echo "| Info | $CHECKSTYLE_INFO |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # PMD Summary
            if [ -f "target/pmd.xml" ]; then
              PMD_VIOLATIONS=$(grep -c '<violation' target/pmd.xml || echo "0")
              echo "### ‚úÖ PMD Analysis" >> $GITHUB_STEP_SUMMARY
              echo "- Total Violations: **$PMD_VIOLATIONS**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # SpotBugs Summary
            if [ -f "target/spotbugsXml.xml" ]; then
              SPOTBUGS_BUGS=$(grep -c '<BugInstance' target/spotbugsXml.xml || echo "0")
              echo "### ‚úÖ SpotBugs Analysis" >> $GITHUB_STEP_SUMMARY
              echo "- Potential Bugs: **$SPOTBUGS_BUGS**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ‚ö†Ô∏è Linting Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Linting tools were not run due to compilation failure." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            compile.log
            compile_exit_code.txt
            target/checkstyle-result.xml
            target/pmd.xml
            target/spotbugsXml.xml
            target/site/
          retention-days: 30
          if-no-files-found: ignore

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## üîç Code Quality Analysis Results\n\n';
            
            const compileStatus = '${{ steps.compile.outputs.status }}';
            const exitCode = '${{ steps.compile.outputs.exit_code }}';
            const failureReason = '${{ steps.compile.outputs.reason }}';
            
            // Compilation Status
            comment += '### üî® Compilation\n';
            if (compileStatus === 'success') {
              comment += '‚úÖ **SUCCESS**\n\n';
            } else {
              comment += `‚ùå **FAILED**\n`;
              comment += `**Reason:** ${failureReason}\n\n`;
              
              // Try to extract and show errors
              try {
                if (fs.existsSync('compile.log')) {
                  const log = fs.readFileSync('compile.log', 'utf8');
                  const errorLines = log.split('\n')
                    .filter(line => line.includes('[ERROR]') && !line.includes('Re-run Maven') && !line.includes('For more information'))
                    .slice(0, 10);
                  
                  if (errorLines.length > 0) {
                    comment += '<details><summary>üìã Compilation Errors (first 10)</summary>\n\n```\n';
                    comment += errorLines.join('\n');
                    comment += '\n```\n</details>\n\n';
                  }
                }
              } catch (e) {
                console.log('Could not parse compilation errors:', e);
              }
            }
            
            // Only show linting if compilation succeeded
            if (compileStatus === 'success') {
              // Parse Checkstyle
              try {
                if (fs.existsSync('target/checkstyle-result.xml')) {
                  const checkstyle = fs.readFileSync('target/checkstyle-result.xml', 'utf8');
                  const errors = (checkstyle.match(/severity="error"/g) || []).length;
                  const warnings = (checkstyle.match(/severity="warning"/g) || []).length;
                  const info = (checkstyle.match(/severity="info"/g) || []).length;
                  
                  comment += '### üìã Checkstyle\n';
                  comment += `- ‚ùå Errors: ${errors}\n`;
                  comment += `- ‚ö†Ô∏è Warnings: ${warnings}\n`;
                  comment += `- ‚ÑπÔ∏è Info: ${info}\n\n`;
                }
              } catch (e) {
                console.log('Could not parse Checkstyle results');
              }
              
              // Parse PMD
              try {
                if (fs.existsSync('target/pmd.xml')) {
                  const pmd = fs.readFileSync('target/pmd.xml', 'utf8');
                  const violations = (pmd.match(/<violation/g) || []).length;
                  comment += '### üîç PMD\n';
                  comment += `- Violations: ${violations}\n\n`;
                }
              } catch (e) {
                console.log('Could not parse PMD results');
              }
              
              // Parse SpotBugs
              try {
                if (fs.existsSync('target/spotbugsXml.xml')) {
                  const spotbugs = fs.readFileSync('target/spotbugsXml.xml', 'utf8');
                  const bugs = (spotbugs.match(/<BugInstance/g) || []).length;
                  comment += '### üêõ SpotBugs\n';
                  comment += `- Potential Bugs: ${bugs}\n\n`;
                }
              } catch (e) {
                console.log('Could not parse SpotBugs results');
              }
            } else {
              comment += '### ‚ö†Ô∏è Linting Analysis\n';
              comment += 'Skipped due to compilation failure.\n\n';
            }
            
            comment += '---\n';
            comment += `üì¶ [Download detailed reports](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
