name: Code Linting and Quality Checks

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

jobs:
  lint:
    name: Java Code Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 1.8
        uses: actions/setup-java@v4
        with:
          java-version: '8.0.442+6'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run TestNG Tests
        id: test
        run: |
          echo "Starting TestNG test execution..."
          
          set +e
          mvn test -DsuiteXmlFile=testng.xml 2>&1 | tee test-output.log
          MAVEN_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          echo "Maven exit code: $MAVEN_EXIT_CODE"
          echo $MAVEN_EXIT_CODE > test_exit_code.txt
          
          # Determine test status
          FAILED=false
          FAILURE_REASON=""
          
          # Check 1: Maven exit code
          if [ $MAVEN_EXIT_CODE -ne 0 ]; then
            FAILED=true
            FAILURE_REASON="Maven exited with code $MAVEN_EXIT_CODE"
          fi
          
          # Check 2: BUILD FAILURE in output
          if grep -q "BUILD FAILURE" test-output.log; then
            FAILED=true
            if grep -q "COMPILATION ERROR" test-output.log; then
              FAILURE_REASON="Compilation error"
            elif grep -q "There are test failures" test-output.log; then
              FAILURE_REASON="Test failures detected"
            else
              FAILURE_REASON="Build failure"
            fi
          fi
          
          # Check 3: TestNG specific failures
          if grep -q "Tests run:.*Failures: [1-9]" test-output.log; then
            FAILED=true
            FAILURE_REASON="TestNG test failures"
          fi
          
          if grep -q "Tests run:.*Errors: [1-9]" test-output.log; then
            FAILED=true
            FAILURE_REASON="TestNG test errors"
          fi
          
          # Extract test summary if available
          TEST_SUMMARY=$(grep -E "Tests run: [0-9]+" test-output.log | tail -1 || echo "No test summary found")
          echo "test_summary=$TEST_SUMMARY" >> $GITHUB_OUTPUT
          
          # Set outputs and exit appropriately
          if [ "$FAILED" = true ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "exit_code=1" >> $GITHUB_OUTPUT
            echo "reason=$FAILURE_REASON" >> $GITHUB_OUTPUT
            echo ""
            echo "=========================================="
            echo "‚ùå TEST EXECUTION FAILED: $FAILURE_REASON"
            echo "=========================================="
            echo ""
            echo "Error details:"
            grep -E "\[ERROR\]|FAILURE|Exception|Error:" test-output.log | grep -v "Re-run Maven" | head -30 || true
            echo ""
            exit 1
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "exit_code=0" >> $GITHUB_OUTPUT
            echo ""
            echo "=========================================="
            echo "‚úÖ TEST EXECUTION SUCCESSFUL"
            echo "Test Summary: $TEST_SUMMARY"
            echo "=========================================="
          fi

      - name: Verify Test Status
        if: always()
        run: |
          echo "Test status: ${{ steps.test.outputs.status }}"
          echo "Exit code: ${{ steps.test.outputs.exit_code }}"
          echo "Reason: ${{ steps.test.outputs.reason }}"
          echo "Test Summary: ${{ steps.test.outputs.test_summary }}"
          
          if [ -f test_exit_code.txt ]; then
            echo "Maven exit code from file: $(cat test_exit_code.txt)"
          fi

      - name: Run Checkstyle (Report Only)
        if: always()
        run: mvn checkstyle:checkstyle || true
        continue-on-error: true

      - name: Run PMD (Report Only)
        if: always()
        run: mvn pmd:pmd || true
        continue-on-error: true

      - name: Run SpotBugs (Report Only)
        if: always()
        run: mvn spotbugs:spotbugs || true
        continue-on-error: true

      - name: Generate Quality Report Summary
        if: always()
        run: |
          echo "## üìä Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Execution Status
          echo "### üß™ Test Execution" >> $GITHUB_STEP_SUMMARY
          TEST_STATUS="${{ steps.test.outputs.status }}"
          
          if [ "$TEST_STATUS" = "success" ]; then
            echo "‚úÖ **Status:** SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "**Summary:** ${{ steps.test.outputs.test_summary }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** FAILED" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** ${{ steps.test.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "test-output.log" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>üìã Click to see error details</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              
              # Extract error lines
              grep -E "\[ERROR\]|COMPILATION ERROR|Failures:|Errors:" test-output.log | grep -v "Re-run Maven" | head -30 >> $GITHUB_STEP_SUMMARY || echo "See test-output.log artifact for full details"
              
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Only show linting results if tests passed
          if [ "$TEST_STATUS" = "success" ]; then
            # Checkstyle Summary
            if [ -f "target/checkstyle-result.xml" ]; then
              CHECKSTYLE_ERRORS=$(grep -o 'severity="error"' target/checkstyle-result.xml | wc -l || echo "0")
              CHECKSTYLE_WARNINGS=$(grep -o 'severity="warning"' target/checkstyle-result.xml | wc -l || echo "0")
              CHECKSTYLE_INFO=$(grep -o 'severity="info"' target/checkstyle-result.xml | wc -l || echo "0")
              echo "### ‚úÖ Checkstyle Analysis" >> $GITHUB_STEP_SUMMARY
              echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Errors | $CHECKSTYLE_ERRORS |" >> $GITHUB_STEP_SUMMARY
              echo "| Warnings | $CHECKSTYLE_WARNINGS |" >> $GITHUB_STEP_SUMMARY
              echo "| Info | $CHECKSTYLE_INFO |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # PMD Summary
            if [ -f "target/pmd.xml" ]; then
              PMD_VIOLATIONS=$(grep -c '<violation' target/pmd.xml || echo "0")
              echo "### ‚úÖ PMD Analysis" >> $GITHUB_STEP_SUMMARY
              echo "- Total Violations: **$PMD_VIOLATIONS**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # SpotBugs Summary
            if [ -f "target/spotbugsXml.xml" ]; then
              SPOTBUGS_BUGS=$(grep -c '<BugInstance' target/spotbugsXml.xml || echo "0")
              echo "### ‚úÖ SpotBugs Analysis" >> $GITHUB_STEP_SUMMARY
              echo "- Potential Bugs: **$SPOTBUGS_BUGS**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ‚ö†Ô∏è Linting Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Linting tools were not run due to test/compilation failure." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            test-output.log
            test_exit_code.txt
            target/surefire-reports/
            target/checkstyle-result.xml
            target/pmd.xml
            target/spotbugsXml.xml
            target/site/
          retention-days: 30
          if-no-files-found: ignore

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## üîç Code Quality Analysis Results\n\n';
            
            const testStatus = '${{ steps.test.outputs.status }}';
            const exitCode = '${{ steps.test.outputs.exit_code }}';
            const failureReason = '${{ steps.test.outputs.reason }}';
            const testSummary = '${{ steps.test.outputs.test_summary }}';
            
            // Test Execution Status
            comment += '### üß™ Test Execution\n';
            if (testStatus === 'success') {
              comment += '‚úÖ **SUCCESS**\n';
              comment += `**Summary:** ${testSummary}\n\n`;
            } else {
              comment += `‚ùå **FAILED**\n`;
              comment += `**Reason:** ${failureReason}\n\n`;
              
              // Try to extract and show errors
              try {
                if (fs.existsSync('test-output.log')) {
                  const log = fs.readFileSync('test-output.log', 'utf8');
                  const errorLines = log.split('\n')
                    .filter(line => 
                      (line.includes('[ERROR]') || line.includes('COMPILATION ERROR') || line.includes('Exception')) 
                      && !line.includes('Re-run Maven')
                    )
                    .slice(0, 15);
                  
                  if (errorLines.length > 0) {
                    comment += '<details><summary>üìã Error Details (first 15 lines)</summary>\n\n```\n';
                    comment += errorLines.join('\n');
                    comment += '\n```\n</details>\n\n';
                  }
                }
              } catch (e) {
                console.log('Could not parse test errors:', e);
              }
            }
            
            // Only show linting if tests passed
            if (testStatus === 'success') {
              // Parse Checkstyle
              try {
                if (fs.existsSync('target/checkstyle-result.xml')) {
                  const checkstyle = fs.readFileSync('target/checkstyle-result.xml', 'utf8');
                  const errors = (checkstyle.match(/severity="error"/g) || []).length;
                  const warnings = (checkstyle.match(/severity="warning"/g) || []).length;
                  const info = (checkstyle.match(/severity="info"/g) || []).length;
                  
                  comment += '### üìã Checkstyle\n';
                  comment += `- ‚ùå Errors: ${errors}\n`;
                  comment += `- ‚ö†Ô∏è Warnings: ${warnings}\n`;
                  comment += `- ‚ÑπÔ∏è Info: ${info}\n\n`;
                }
              } catch (e) {
                console.log('Could not parse Checkstyle results');
              }
              
              // Parse PMD
              try {
                if (fs.existsSync('target/pmd.xml')) {
                  const pmd = fs.readFileSync('target/pmd.xml', 'utf8');
                  const violations = (pmd.match(/<violation/g) || []).length;
                  comment += '### üîç PMD\n';
                  comment += `- Violations: ${violations}\n\n`;
                }
              } catch (e) {
                console.log('Could not parse PMD results');
              }
              
              // Parse SpotBugs
              try {
                if (fs.existsSync('target/spotbugsXml.xml')) {
                  const spotbugs = fs.readFileSync('target/spotbugsXml.xml', 'utf8');
                  const bugs = (spotbugs.match(/<BugInstance/g) || []).length;
                  comment += '### üêõ SpotBugs\n';
                  comment += `- Potential Bugs: ${bugs}\n\n`;
                }
              } catch (e) {
                console.log('Could not parse SpotBugs results');
              }
            } else {
              comment += '### ‚ö†Ô∏è Linting Analysis\n';
              comment += 'Skipped due to test/compilation failure.\n\n';
            }
            
            comment += '---\n';
            comment += `üì¶ [Download detailed reports](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
