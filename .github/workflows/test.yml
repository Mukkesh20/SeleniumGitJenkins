name: Code Linting and Quality Checks

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

# Required for PR comments
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  lint:
    name: Java Code Linting (Changed Files Only)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Java Files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
            
            echo "Comparing $BASE_SHA...$HEAD_SHA"
            CHANGED_FILES=$(git diff --name-only --diff-filter=AMR $BASE_SHA...$HEAD_SHA | grep '\.java$' || true)
          else
            CHANGED_FILES=$(git diff --name-only --diff-filter=AMR HEAD~1 HEAD | grep '\.java$' || true)
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No Java files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "file_count=0" >> $GITHUB_OUTPUT
          else
            FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
            echo "Found $FILE_COUNT changed Java file(s):"
            echo "$CHANGED_FILES"
            
            echo "$CHANGED_FILES" > changed_files.txt
            
            CHANGED_FILES_SPACE=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            echo "changed_files=$CHANGED_FILES_SPACE" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK 1.8
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '8.0.442+6'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Compile Project
        id: compile
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          echo "============================================"
          echo "Starting Maven Compilation"
          echo "============================================"
          
          # Run maven and capture exit code directly (no pipes)
          mvn clean compile -DskipTests > compile.log 2>&1 || true
          MAVEN_EXIT_CODE=$?
          
          echo "Maven raw exit code: $MAVEN_EXIT_CODE"
          
          # Also check the log file for indicators
          echo ""
          echo "============================================"
          echo "Analyzing compilation output..."
          echo "============================================"
          
          # Display the full log
          cat compile.log
          
          echo ""
          echo "============================================"
          echo "Checking for failure indicators..."
          echo "============================================"
          
          COMPILE_FAILED=false
          FAILURE_REASON=""
          
          # Check 1: Look for COMPILATION ERROR
          if grep -q "\[ERROR\] COMPILATION ERROR" compile.log; then
            COMPILE_FAILED=true
            FAILURE_REASON="COMPILATION ERROR found"
            echo "‚ùå Found: COMPILATION ERROR"
          fi
          
          # Check 2: Look for BUILD FAILURE
          if grep -q "BUILD FAILURE" compile.log; then
            COMPILE_FAILED=true
            FAILURE_REASON="BUILD FAILURE found"
            echo "‚ùå Found: BUILD FAILURE"
          fi
          
          # Check 3: Look for "cannot find symbol"
          if grep -q "cannot find symbol" compile.log; then
            COMPILE_FAILED=true
            FAILURE_REASON="Cannot find symbol error"
            echo "‚ùå Found: cannot find symbol"
          fi
          
          # Check 4: Look for "package does not exist"
          if grep -q "package .* does not exist" compile.log; then
            COMPILE_FAILED=true
            FAILURE_REASON="Package does not exist error"
            echo "‚ùå Found: package does not exist"
          fi
          
          # Check 5: Look for "error:" pattern from javac
          if grep -qE "^\[ERROR\].*\.java:\[[0-9]+,[0-9]+\]" compile.log; then
            COMPILE_FAILED=true
            FAILURE_REASON="Java compilation error"
            echo "‚ùå Found: Java compilation error pattern"
          fi
          
          # Check 6: Count [ERROR] lines (excluding noise)
          ERROR_COUNT=$(grep -c "^\[ERROR\]" compile.log 2>/dev/null || echo "0")
          echo "Total [ERROR] lines: $ERROR_COUNT"
          
          if [ "$ERROR_COUNT" -gt 2 ]; then
            COMPILE_FAILED=true
            FAILURE_REASON="Multiple errors detected ($ERROR_COUNT)"
            echo "‚ùå Found: $ERROR_COUNT error lines"
          fi
          
          echo ""
          echo "============================================"
          echo "Final Result"
          echo "============================================"
          
          if [ "$COMPILE_FAILED" = true ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "reason=$FAILURE_REASON" >> $GITHUB_OUTPUT
            echo ""
            echo "‚ùå COMPILATION FAILED: $FAILURE_REASON"
            echo ""
            echo "Error Summary:"
            echo "----------------------------------------"
            grep -E "^\[ERROR\]" compile.log | grep -v "Re-run Maven" | grep -v "For more information" | head -25
            echo "----------------------------------------"
            exit 1
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "reason=none" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úÖ COMPILATION SUCCESSFUL"
          fi

      - name: Run Checkstyle on Changed Files
        id: checkstyle
        if: steps.changed-files.outputs.has_changes == 'true' && steps.compile.outputs.status == 'success'
        run: |
          echo "Running Checkstyle..."
          mvn checkstyle:checkstyle -Dcheckstyle.failOnViolation=false || true
          
          if [ -f "target/checkstyle-result.xml" ]; then
            ERRORS=$(grep -c 'severity="error"' target/checkstyle-result.xml 2>/dev/null || echo "0")
            WARNINGS=$(grep -c 'severity="warning"' target/checkstyle-result.xml 2>/dev/null || echo "0")
            echo "checkstyle_errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "checkstyle_warnings=$WARNINGS" >> $GITHUB_OUTPUT
            echo "Checkstyle: $ERRORS errors, $WARNINGS warnings"
          else
            echo "checkstyle_errors=0" >> $GITHUB_OUTPUT
            echo "checkstyle_warnings=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run PMD on Changed Files
        id: pmd
        if: steps.changed-files.outputs.has_changes == 'true' && steps.compile.outputs.status == 'success'
        run: |
          echo "Running PMD..."
          mvn pmd:pmd || true
          
          if [ -f "target/pmd.xml" ]; then
            VIOLATIONS=$(grep -c '<violation' target/pmd.xml 2>/dev/null || echo "0")
            echo "pmd_violations=$VIOLATIONS" >> $GITHUB_OUTPUT
            echo "PMD: $VIOLATIONS violations"
          else
            echo "pmd_violations=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run SpotBugs on Changed Files
        id: spotbugs
        if: steps.changed-files.outputs.has_changes == 'true' && steps.compile.outputs.status == 'success'
        run: |
          echo "Running SpotBugs..."
          mvn spotbugs:spotbugs || true
          
          if [ -f "target/spotbugsXml.xml" ]; then
            BUGS=$(grep -c '<BugInstance' target/spotbugsXml.xml 2>/dev/null || echo "0")
            echo "spotbugs_bugs=$BUGS" >> $GITHUB_OUTPUT
            echo "SpotBugs: $BUGS potential bugs"
          else
            echo "spotbugs_bugs=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Generate Quality Report Summary
        if: always()
        run: |
          echo "## üìä Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          HAS_CHANGES="${{ steps.changed-files.outputs.has_changes }}"
          
          if [ "$HAS_CHANGES" != "true" ]; then
            echo "### ‚ÑπÔ∏è No Java Files Changed" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Changed Files
          echo "### üìÅ Changed Files (${{ steps.changed-files.outputs.file_count }})" >> $GITHUB_STEP_SUMMARY
          if [ -f "changed_files.txt" ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat changed_files.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Compilation
          echo "### üî® Compilation" >> $GITHUB_STEP_SUMMARY
          COMPILE_STATUS="${{ steps.compile.outputs.status }}"
          if [ "$COMPILE_STATUS" = "success" ]; then
            echo "‚úÖ **SUCCESS**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **FAILED** - ${{ steps.compile.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
            if [ -f "compile.log" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>View Errors</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              grep -E "^\[ERROR\]" compile.log | grep -v "Re-run Maven" | head -25 >> $GITHUB_STEP_SUMMARY || true
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Linting (only if compile succeeded)
          if [ "$COMPILE_STATUS" = "success" ]; then
            echo "### üìã Linting Results" >> $GITHUB_STEP_SUMMARY
            echo "| Tool | Issues |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Checkstyle Errors | ${{ steps.checkstyle.outputs.checkstyle_errors || '0' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Checkstyle Warnings | ${{ steps.checkstyle.outputs.checkstyle_warnings || '0' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| PMD Violations | ${{ steps.pmd.outputs.pmd_violations || '0' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| SpotBugs | ${{ steps.spotbugs.outputs.spotbugs_bugs || '0' }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è Linting Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Linting was skipped due to compilation failure." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            changed_files.txt
            compile.log
            target/checkstyle-result.xml
            target/pmd.xml
            target/spotbugsXml.xml
          retention-days: 30
          if-no-files-found: ignore

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            const hasChanges = '${{ steps.changed-files.outputs.has_changes }}';
            const fileCount = '${{ steps.changed-files.outputs.file_count }}';
            const compileStatus = '${{ steps.compile.outputs.status }}';
            const compileReason = '${{ steps.compile.outputs.reason }}';
            
            let comment = '## üîç Code Quality Analysis\n\n';
            
            if (hasChanges !== 'true') {
              comment += '### ‚ÑπÔ∏è No Java Files Changed\n';
              comment += 'No Java files were modified in this PR.\n';
            } else {
              // Changed files section
              comment += `### üìÅ Changed Java Files (${fileCount})\n`;
              try {
                if (fs.existsSync('changed_files.txt')) {
                  const files = fs.readFileSync('changed_files.txt', 'utf8').trim();
                  comment += '<details><summary>View files</summary>\n\n```\n';
                  comment += files;
                  comment += '\n```\n</details>\n\n';
                }
              } catch (e) {
                console.log('Could not read changed files:', e);
              }
              
              // Compilation section
              comment += '### üî® Compilation\n';
              if (compileStatus === 'success') {
                comment += '‚úÖ **SUCCESS**\n\n';
              } else {
                comment += `‚ùå **FAILED** - ${compileReason}\n\n`;
                
                try {
                  if (fs.existsSync('compile.log')) {
                    const log = fs.readFileSync('compile.log', 'utf8');
                    const errorLines = log.split('\n')
                      .filter(line => line.startsWith('[ERROR]') && !line.includes('Re-run Maven') && !line.includes('For more information'))
                      .slice(0, 15);
                    
                    if (errorLines.length > 0) {
                      comment += '<details><summary>üìã Compilation Errors</summary>\n\n```\n';
                      comment += errorLines.join('\n');
                      comment += '\n```\n</details>\n\n';
                    }
                  }
                } catch (e) {
                  console.log('Could not parse compile log:', e);
                }
              }
              
              // Linting section (only if compile succeeded)
              if (compileStatus === 'success') {
                const checkstyleErrors = '${{ steps.checkstyle.outputs.checkstyle_errors }}' || '0';
                const checkstyleWarnings = '${{ steps.checkstyle.outputs.checkstyle_warnings }}' || '0';
                const pmdViolations = '${{ steps.pmd.outputs.pmd_violations }}' || '0';
                const spotbugsBugs = '${{ steps.spotbugs.outputs.spotbugs_bugs }}' || '0';
                
                comment += '### üìã Linting Results\n';
                comment += '| Tool | Issues |\n';
                comment += '|------|--------|\n';
                comment += `| Checkstyle Errors | ${checkstyleErrors} |\n`;
                comment += `| Checkstyle Warnings | ${checkstyleWarnings} |\n`;
                comment += `| PMD Violations | ${pmdViolations} |\n`;
                comment += `| SpotBugs | ${spotbugsBugs} |\n`;
              } else {
                comment += '### ‚ö†Ô∏è Linting Skipped\n';
                comment += 'Linting was skipped due to compilation failure.\n';
              }
            }
            
            comment += '\n---\n';
            comment += `üì¶ [View Full Report](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            try {
              // Try to find and update existing comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              const botComment = comments.find(c => 
                c.user.login === 'github-actions[bot]' && 
                c.body.includes('Code Quality Analysis')
              );
              
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
                console.log('Updated existing comment');
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
                console.log('Created new comment');
              }
            } catch (e) {
              console.log('Error posting comment:', e);
              core.warning('Could not post PR comment. Check repository permissions.');
            }
